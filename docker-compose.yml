services:
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: rrhh_api
    restart: unless-stopped
    expose:
      - "${PORT}"
    environment:
      - PORT=${PORT}
      - DB_TYPE=mongodb
      - DB_URI=mongodb://mongodb:27017/rrhh-postulantes
      - JWT_SECRET=${JWT_SECRET}
      - BCRYPT_SALT=${BCRYPT_SALT}
      - BCRYPT_SECRET=${BCRYPT_SECRET}
      - SESSION_EXPIRES=1h
      - STORAGE_PATH=/storage/postulantes
      # - CORS_ORIGIN=http://localhost,http://localhost:5173
      # - CORS_ORIGIN=http ://64.181.170.115,http://64.181.170.115:80
      - CORS_ORIGIN=${CORS_ORIGIN}
    volumes:
      - /srv/data/rrhh-postulantes/storage/postulantes:/storage/postulantes
    depends_on:
      - mongodb

  web:
    build:
      # me lo hizo comentar chatgpt para que use la imagen de docker hub
      # y reemplazar por image: cristianponte/rrhh-postulantes-web:latest
      # tiempo despues lo volvi a poner para que se actualice desde aca.
      context: ./web
      dockerfile: Dockerfile
    #image: cristianponte/rrhh-postulantes-web:latest
    container_name: rrhh_web
    restart: unless-stopped
    # Cambio sugerido por ChatGPT para que funcione en Oracle Cloud el 443 HTTPS
    #ports:
    #  - "80:80"
    expose:
      - "80"
    environment:
      #- VITE_API_URL=http://localhost:5000/api
      #- VITE_API_URL=http://64.181.170.115:5000/api
      # Esta se cambia para que ande en desarrollo y en el site
      # Al poner solo /api, le dices al navegador: "Busca la carpeta de la API en el mismo servidor donde estás cargando la página"
      # Esto funciona igual en tu PC (localhost) y en Oracle (la IP pública) porque es una ruta relativa.
      - VITE_API_URL=/api
      # agregado por ChatGPT para el manejo de dominios
      - VIRTUAL_PORT=80
      - VIRTUAL_HOST=${DOMAIN},localhost
      - LETSENCRYPT_HOST=${DOMAIN}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
    depends_on:
      - api

  mongodb:
    image: mongo:8
    container_name: rrhh_mongodb
    restart: unless-stopped
    volumes:
      - mongodb_data:/data/db

  # Agregado por ChatGPT para gestionar los puertos 80 y 443
  nginx-proxy:
    image: nginxproxy/nginx-proxy:alpine
    container_name: rrhh_nginx_proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - /srv/data/rrhh-postulantes/nginx/certs:/etc/nginx/certs
      - /srv/data/rrhh-postulantes/nginx/vhost.d:/etc/nginx/vhost.d
      - /srv/data/rrhh-postulantes/nginx/html:/usr/share/nginx/html
      # agregada por ChatGPT, para usar un archivo de configuración global que permita
      # regular el tamaño de archivos que se sube. crear ese achivo en el server y escribir:
      # client_max_body_size 20M;
      # proxy_connect_timeout 300;
      # proxy_send_timeout 300;
      # proxy_read_timeout 300;
      # send_timeout 300;
      - /srv/data/rrhh-postulantes/nginx/global.conf:/etc/nginx/conf.d/zzz_global.conf:ro

  nginx-letsencrypt:
    image: nginxproxy/acme-companion
    container_name: rrhh_letsencrypt
    restart: unless-stopped
    depends_on:
      - nginx-proxy
    environment:
      - DEFAULT_EMAIL=${LETSENCRYPT_EMAIL}
      - NGINX_PROXY_CONTAINER=rrhh_nginx_proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /srv/data/rrhh-postulantes/nginx/certs:/etc/nginx/certs
      - /srv/data/rrhh-postulantes/nginx/vhost.d:/etc/nginx/vhost.d
      - /srv/data/rrhh-postulantes/nginx/html:/usr/share/nginx/html

volumes:
  mongodb_data:
