services:
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: rrhh_api
    restart: unless-stopped
      # agregado por ChatGPT problemas de permisos, 
      # asi corre la app con el usuario de ubuntu pro default sin problemas de permisos
    user: "${APP_UID}:${APP_GID}"
    ports:
      - "${PORT}:${PORT}"
    environment:
      - PORT=${PORT}
      - DB_TYPE=mongodb
      - DB_URI=mongodb://mongodb:27017/rrhh-postulantes
      - JWT_SECRET=super_secret_key_change_me
      - BCRYPT_SALT=10
      - BCRYPT_SECRET=another_super_secret_encryption_word
      - SESSION_EXPIRES=1h
      - STORAGE_PATH=/storage/postulantes
      # - CORS_ORIGIN=http://localhost,http://localhost:5173
      # - CORS_ORIGIN=http ://64.181.170.115,http://64.181.170.115:80
      - CORS_ORIGIN=http://localhost,http://64.181.170.115
    volumes:
      - type: bind
        source: ./storage
        target: /storage
    depends_on:
      - mongodb

  web:
    build:
      # me lo hizo comentar chatgpt para que use la imagen de docker hub
      # y reemplazar por image: cristianponte/rrhh-postulantes-web:latest
      # tiempo despues lo volvi a poner para que se actualice desde aca
      context: ./web
      dockerfile: Dockerfile
    #image: cristianponte/rrhh-postulantes-web:latest
    container_name: rrhh_web
    restart: unless-stopped
    # Cambio sugerido por ChatGPT para que funcione en Oracle Cloud el 443 HTTPS
    #ports:
    #  - "80:80"
    expose:
      - "80"
    environment:
      #- VITE_API_URL=http://localhost:5000/api
      #- VITE_API_URL=http://64.181.170.115:5000/api
      # Esta se cambia para que ande en desarrollo y en el site
      # Al poner solo /api, le dices al navegador: "Busca la carpeta de la API en el mismo servidor donde estás cargando la página"
      # Esto funciona igual en tu PC (localhost) y en Oracle (la IP pública) porque es una ruta relativa.
      - VITE_API_URL=/api
      # agregado por ChatGPT para el manejo de dominios
      - VIRTUAL_PORT=80
      - VIRTUAL_HOST=${DOMAIN},localhost
      - LETSENCRYPT_HOST=${DOMAIN}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
    depends_on:
      - api

  mongodb:
    image: mongo:latest
    container_name: rrhh_mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - ~/rrhh-postulantes/mongodb_data:/data/db

  # Agregado por ChatGPT para gestionar los puertos 80 y 443
  nginx-proxy:
    image: nginxproxy/nginx-proxy:alpine
    container_name: rrhh_nginx_proxy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./certs:/etc/nginx/certs
      - ./vhost.d:/etc/nginx/vhost.d
      - ./html:/usr/share/nginx/html
      # agregada por ChatGPT El nombre zzz_ es intencional: fuerza a que se cargue al final
      - ./nginx-proxy/global.conf:/etc/nginx/conf.d/zzz_global.conf:ro

  nginx-letsencrypt:
    image: nginxproxy/acme-companion
    container_name: rrhh_letsencrypt
    restart: unless-stopped
    depends_on:
      - nginx-proxy
    environment:
      - DEFAULT_EMAIL=${LETSENCRYPT_EMAIL}
      - NGINX_PROXY_CONTAINER=rrhh_nginx_proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./certs:/etc/nginx/certs
      - ./vhost.d:/etc/nginx/vhost.d
      - ./html:/usr/share/nginx/html

#  postgres:
#    image: postgres:15-alpine
#    container_name: rrhh_postgres
#    restart: unless-stopped
#    environment:
#      POSTGRES_USER: postgres
#      POSTGRES_PASSWORD: password
#      POSTGRES_DB: rrhh-postulantes
#    ports:
#      - "5432:5432"
#    volumes:
#      - postgres_data:/var/lib/postgresql/data

#volumes:
#  postgres_data:
