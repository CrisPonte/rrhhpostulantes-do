---
phase: 1
plan: 2
wave: 2
---

# Plan 1.2: Database Entities & Repository Pattern

## Objective
Implement Mongoose schemas and Base Repository pattern to support the initial foundation entities (Users, Roles, Postulantes, Puestos, TÃ­tulos, Portales).

## Context
- `.gsd/SPEC.md`
- `.gsd/DECISIONS.md`
- `.gsd/ROADMAP.md`

## Tasks

<task type="auto">
  <name>Configure Database Connection</name>
  <files>
    - api/config/db.js
    - api/server.js
  </files>
  <action>
    - Create a database connection file `api/config/db.js`.
    - Setup mongoose connection to MongoDB using `DB_URI`.
    - Provide a robust reconnect or retry logic and console logging on success/failure.
    - Call this connection setup on `api/server.js` startup.
  </action>
  <verify>node api/server.js (verify that it logs "Connected to MongoDB" appropriately if DB is running).</verify>
  <done>`api/config/db.js` successfully exports a connect function that functions properly.</done>
</task>

<task type="auto">
  <name>Mongoose Entity Schemas</name>
  <files>
    - api/models/Usuario.js
    - api/models/Rol.js
    - api/models/Postulante.js
    - api/models/Puesto.js
    - api/models/Titulo.js
    - api/models/Portal.js
  </files>
  <action>
    - Ensure UUIDv4 is configured as the `_id` field across schemas where required per SPEC.
    - Define schemas based on attributes found in RFP.
    - Attach audit fields: `createdAt`, `createdBy`, `updatedAt`, `updatedBy`, `deleted` (boolean, logic remove), `deletedAt`, `deletedBy`, `physicalDeletedAt`, `physicalDeletedBy`.
    - Users need Role references.
    - Make strings trimmed and default `deleted` to false.
  </action>
  <verify>grep "mongoose.model" api/models/*.js</verify>
  <done>All six core entity schemas are defined with their corresponding attributes and audit fields in place.</done>
</task>

<task type="auto">
  <name>Base Repository & User Repository</name>
  <files>
    - api/repositories/BaseRepository.js
    - api/repositories/MongoRepository.js
    - api/repositories/UsuarioRepository.js
  </files>
  <action>
    - Design a generic `api/repositories/MongoRepository.js` logic with CRUD operations (`findById`, `findAll`, `create`, `update`, `softDelete`, `hardDelete`).
    - Enforce the `deleted: false` check on `findById` and `findAll` by default.
    - Implement `api/repositories/UsuarioRepository.js` inheriting from or composing the generic operations and exposing specific ones (e.g. `findByEmail`).
    - Use variables from `.env` or application config (like `DB_TYPE`) to decide what repository logic to initialize (prepare a simple factory `api/repositories/index.js` or DI structure).
  </action>
  <verify>ls api/repositories</verify>
  <done>Base repository structure is available as a blueprint, and initial User repository is hooked up.</done>
</task>

## Success Criteria
- [ ] Mongoose successfully connects during API startup flow.
- [ ] Essential entities (User, Role, Postulante, Support tables) are strictly modeled according to RFP.
- [ ] Repository Pattern is defined allowing for future swapping of data sources as per the `DB_TYPE` variable.
