---
phase: 2
plan: 1
wave: 1
---

# Plan 2.1: Authentication & Security Middlewares

## Objective
Implement password hashing with bcrypt, JWT token generation/validation, and Role-Based Access Control (RBAC) middleware to secure API endpoints based on the three default roles (`admin`, `jefe de rrhh`, `staff`).

## Context
- `.gsd/SPEC.md`
- `.gsd/DECISIONS.md`
- `.gsd/ROADMAP.md`

## Tasks

<task type="auto">
  <name>Install Security Dependencies</name>
  <files>
    - api/package.json
  </files>
  <action>
    - Install `bcryptjs` and `jsonwebtoken` packages via npm.
    - Check if `api/.env.example` already has `JWT_SECRET`, `BCRYPT_SALT`, and `SESSION_EXPIRES`. (It should based on Phase 1).
  </action>
  <verify>grep bcryptjs api/package.json</verify>
  <done>Dependencies `bcryptjs` and `jsonwebtoken` are present in package.json.</done>
</task>

<task type="auto">
  <name>Auth Service & Controller</name>
  <files>
    - api/services/AuthService.js
    - api/controllers/AuthController.js
    - api/routes/auth.routes.js
    - api/server.js
  </files>
  <action>
    - Create `AuthService` handling `login(email, password)` which uses `UsuarioRepository.findByEmail(email)`. It should compare the password using `bcryptjs` and generate a `jsonwebtoken` containing `userId` and `rol`.
    - Create `AuthController.js` mapping the login request to the service.
    - Create `auth.routes.js` exposing `POST /api/auth/login`.
    - Integrate `auth.routes.js` into `server.js` under `/api/auth`.
  </action>
  <verify>grep "/api/auth" api/server.js</verify>
  <done>Auth endpoint `/api/auth/login` is exposed by the express server.</done>
</task>

<task type="auto">
  <name>Auth & RBAC Middleware</name>
  <files>
    - api/middlewares/auth.middleware.js
    - api/middlewares/rbac.middleware.js
  </files>
  <action>
    - Create `auth.middleware.js` to extract JWT from Authorization header (`Bearer ...`), verify it using `JWT_SECRET`, and attach decoded data to `req.user`.
    - Return 401 Unauthorized if missing/invalid.
    - Create `rbac.middleware.js` exporting a function `requireRoles([...allowedRoles])`.
    - This middleware should check if `req.user.rol` is inside the `allowedRoles` array, and return 403 Forbidden otherwise.
  </action>
  <verify>ls api/middlewares/auth.middleware.js && ls api/middlewares/rbac.middleware.js</verify>
  <done>Both `auth` and `rbac` middlewares are available for routing protection.</done>
</task>

## Success Criteria
- [ ] Security dependencies are correctly installed.
- [ ] A JWT token can be conceptually generated via `/api/auth/login` endpoint.
- [ ] Route middlewares are ready to enforce Admin, Jefe RRHH, and Staff permissions.
