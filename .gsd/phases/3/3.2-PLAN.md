---
phase: 3
plan: 2
wave: 2
---

# Plan 3.2: Storage Service & File Management

## Objective
Implement specialized logic for managing applicant files in the local filesystem, ensuring directory naming standards, security constraints, and automatic renaming.

## Context
- `.gsd/SPEC.md` (Section 4: GESTIÃ“N DE ARCHIVOS)
- `api/server.js` (for multer integration)

## Tasks

<task type="auto">
  <name>Multer Configuration & Storage Service</name>
  <files>
    - api/services/StorageService.js
    - api/package.json
  </files>
  <action>
    - Install `multer` package.
    - Create `api/services/StorageService.js`.
    - Implement `getApplicantPath(apellido, nombre, dni)` helper.
    - Implement `initApplicantDirectory(apellido, nombre, dni)` to ensure folder existence.
    - Implement `renameApplicantDirectory(oldData, newData)` to handle `fs.renameSync` when candidate identity changes.
    - Implement `saveFile(applicantData, file)` with validation: max 10 files, block executables (`.exe`, `.bat`, `.sh`).
    - Implement `deleteFile(applicantData, filename)`.
    - Implement `deleteApplicantDirectory(applicantData)` for hard delete use case.
  </action>
  <verify>ls api/services/StorageService.js</verify>
  <done>Storage service handles folder lifecycle and file security rules.</done>
</task>

<task type="auto">
  <name>File Upload Integration</name>
  <files>
    - api/routes/postulantes.routes.js
    - api/controllers/PostulanteController.js
  </files>
  <action>
    - Add `multer` middleware to Postulante routes (e.g., `POST /api/postulantes/:id/files`).
    - Update `PostulanteController` to handle file uploads via `StorageService`.
    - Ensure `Postulante` model is updated with file references (if needed) or simply trust the FS structure.
    - Update `update` method in `PostulanteController` to trigger `StorageService.renameApplicantDirectory` if `apellido`, `nombre`, or `dni` change.
  </action>
  <verify>grep "multer" api/routes/postulantes.routes.js</verify>
  <done>Postulante endpoints can now receive and store documents.</done>
</task>

## Success Criteria
- [ ] Multas and StorageService are integrated in the flow.
- [ ] Executable files are rejected.
- [ ] Folders are renamed automatically when candidate data changes.
- [ ] Files are stored in `/storage/postulantes/Apellido-Nombre-DNI`.
